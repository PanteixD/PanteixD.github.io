<!DOCTYPE html>
<html>
<head>
<title>Tiny Civilization - Procedural</title>
<meta charset="UTF-8">
<style>
  /* --- General Styles --- */
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; display: flex; flex-direction: column; align-items: center; background-color: #e8eff5; margin: 0; padding: 20px; color: #333; }
  h1 { color: #2c3e50; margin-bottom: 10px; }

  /* Language Switcher */
  #language-switcher { position: absolute; top: 15px; left: 15px; z-index: 10; }
  #language-switch-button {
      padding: 8px 12px;
      font-size: 14px;
      background-color: #5dade2; /* Lighter blue */
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: background-color 0.2s ease;
  }
  #language-switch-button:hover {
      background-color: #3498db; /* Standard blue on hover */
  }


  /* --- Unit Display Bar --- */
  #unit-display-bar { display: flex; justify-content: center; align-items: center; gap: 10px; padding: 10px; margin-bottom: 15px; min-height: 40px; background-color: #dde8f0; border-radius: 8px; border: 1px solid #c8d6e1; flex-wrap: wrap; }
  .unit-icon { width: 35px; height: 35px; border: 2px solid #adb5bd; background-color: #ced4da; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; cursor: pointer; transition: all 0.2s ease; position: relative; }
  .unit-icon:hover { border-color: #495057; background-color: #e9ecef; transform: scale(1.05); } /* Added scale */
  .unit-icon.selected { border-color: #007bff; box-shadow: 0 0 8px rgba(0, 123, 255, 0.5); transform: scale(1.1); }
  .unit-icon[data-unit-type="pawn"] { background-color: #3498db; color: white; }
  .unit-icon[data-unit-type="worker"] { background-color: #e67e22; color: white; }

  /* --- Alert Message --- */
  #alert-message { padding: 10px 20px; margin-top: 10px; border-radius: 8px; background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; font-weight: bold; text-align: center; opacity: 0; transition: opacity 0.5s ease-in-out; max-width: 550px; width: 90%; box-sizing: border-box; position: relative; left: 50%; transform: translateX(-50%); display: none; z-index: 20; /* Ensure alert is on top */}
  #alert-message.show { display: block; opacity: 1; }

  /* --- Game Layout --- */
  #game-container { display: flex; justify-content: center; align-items: flex-start; margin-top: 20px; flex-wrap: wrap; gap: 30px; background-color: #ffffff; padding: 30px; border-radius: 16px; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); max-width: 1200px; width: 100%; position: relative; }
  #left-container, #right-panel { display: flex; flex-direction: column; align-items: stretch; gap: 20px; flex: 1; min-width: 250px; }
  #grid-area { display: flex; flex-direction: column; align-items: center; flex-shrink: 0; min-width: 585px; }
  #grid { display: grid; grid-template-columns: repeat(10, 55px); grid-template-rows: repeat(10, 55px); gap: 5px; padding: 15px; background-color: #b0bec5; /* Changed background to indicate potential unknown */ border-radius: 12px; border: 1px solid #90a4ae; margin-bottom: 10px; position: relative; /* Needed for absolute positioning of markers? */ }

  /* --- Tiles --- */
  .tile { width: 55px; height: 55px; border: 1px solid #cfd8dc; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; cursor: pointer; overflow: hidden; border-radius: 8px; transition: all 0.2s ease-in-out; background-color: #eceff1; /* Default empty/revealed color */ color: #555; position: relative; }
  .tile.unknown { background-color: #b0bec5; cursor: default; } /* Style for unrevealed tiles */
  .tile:not(.unknown):hover { transform: scale(1.05); box-shadow: 0 0 8px rgba(0, 0, 0, 0.1); z-index: 1; }
  .unit-marker { border-radius: 50%; width: 70%; height: 70%; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; color: white; position: absolute; z-index: 2; box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3); pointer-events: none; }
  .unit-marker.pawn { background-color: #3498db; } .unit-marker.worker { background-color: #e67e22; }
  .unit-marker.selected { outline: 3px solid #007bff; outline-offset: 2px; }

  /* Resource & Building Styles */
  .tile.tree { background-color: #2ecc71; color: #fff; } .tile.stone { background-color: #95a5a6; color: #fff; } .tile.flint { background-color: #7f8c8d; color: #fff; }
  /* Building styles applied as classes */
  .tile.house, .tile.farm, .tile.mine { text-align: center; line-height: 55px; font-weight: bold; }
  .tile.farm { background-color: #f1c40f; color: #333; font-size: 11px; } .tile.mine { background-color: #607d8b; color: white; font-size: 11px; } .tile.house { background-color: #8e44ad; color: white; font-size: 11px; }
  .highlight { background-color: rgba(52, 152, 219, 0.2) !important; border: 1px solid #3498db !important; } /* Use !important to override base styles */

  /* --- Buttons --- */
  button { padding: 12px 20px; font-size: 16px; cursor: pointer; border: none; border-radius: 8px; background-color: #3498db; color: white; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); font-weight: 600; margin-top: 5px; }
  button:hover:not(:disabled) { background-color: #2980b9; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); transform: translateY(-1px); }
  button:active:not(:disabled) { transform: translateY(0px); box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
  button:disabled { background-color: #bdc3c7; cursor: default; opacity: 0.7; }
  #action-button { background-color: #e67e22; } #action-button:hover:not(:disabled) { background-color: #d35400; }
  #research-button, #buildings-button, #units-button, #logs-button { background-color: #9b59b6; margin-top: 10px; }
  #research-button:hover:not(:disabled), #buildings-button:hover:not(:disabled), #units-button:hover:not(:disabled), #logs-button:hover:not(:disabled) { background-color: #8e44ad; }
  #units-button { background-color: #16a085; } #units-button:hover:not(:disabled) { background-color: #117a65; }
  #logs-button { background-color: #34495e; } #logs-button:hover:not(:disabled) { background-color: #2c3e50; }
  .research-item button { background-color: #2ecc71; padding: 8px 15px; font-size: 14px; } .research-item button:hover:not(:disabled) { background-color: #27ae60; }
  #buildings-list li button, #units-list li button { background-color: #f1c40f; color: #333; padding: 8px 15px; font-size: 14px; } /* Style unit deploy button */
  #buildings-list li button:hover:not(:disabled), #units-list li button:hover:not(:disabled) { background-color: #f39c12; }
  #units-list li button#deploy-worker-button { background-color: #27ae60; color: white; } /* Specific style for worker button */
  #units-list li button#deploy-worker-button:hover:not(:disabled) { background-color: #2ecc71; }
  #save-button { background-color: #27ae60; margin-top: 10px; } #save-button:hover:not(:disabled) { background-color: #229954; } /* Save Button Style */
  #load-button { background-color: #f39c12; margin-top: 10px; } #load-button:hover:not(:disabled) { background-color: #e67e22; } /* Load Button Style */


  /* --- Panels --- */
  #inventory, #tech-tree, #buildings-list, #units-panel, #logs-panel { text-align: left; background-color: #fdfefe; padding: 20px; border-radius: 12px; border: 1px solid #e4e9ed; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); }
  #inventory { display: block; } /* Inventory always visible */
  #tech-tree, #buildings-list, #units-panel, #logs-panel { display: none; } /* Others hidden by default */
  #tech-tree, #buildings-list, #units-panel, #logs-panel { max-height: 300px; overflow-y: auto; } /* Add scroll for panels */
  #logs-list { list-style-type: none; padding: 0; margin: 0; font-size: 14px; line-height: 1.5; color: #555; margin-top: 10px; }
  #logs-list li { padding: 4px 0; border-bottom: 1px dashed #eee; white-space: pre-wrap; } #logs-list li:last-child { border-bottom: none; }
  #logs-list .log-time { display: inline-block; width: 50px; color: #888; margin-right: 5px; }
  #log-search-input { width: 100%; padding: 8px 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
  #log-filter-container { display: block; margin-bottom: 10px; font-size: 14px; color: #555; }
  #log-filter-checkbox { margin-right: 5px; vertical-align: middle; }

  /* Panel Headers & Lists */
  #inventory h2, #tech-tree h2, #buildings-list h2, #units-panel h2, #logs-panel h2 { font-size: 20px; color: #2c3e50; margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
  #inventory p { font-size: 16px; color: #555; margin-bottom: 8px; line-height: 1.4; } #inventory span { font-weight: bold; color: #333; }
  #tech-tree h3 { font-size: 18px; color: #3498db; margin-bottom: 10px; }
  #tech-tree ul, #buildings-list ul, #units-list ul { list-style-type: none; padding: 0; margin: 0; }
  #tech-tree li, #buildings-list li, #units-list li { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #eee; }
  #tech-tree li:last-child, #buildings-list li:last-child, #units-list li:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }

  /* --- Other UI --- */
   #colony-name-display { font-size: 22px; color: #2c3e50; font-weight: bold; margin-bottom: 0; text-align: left; padding: 10px; background-color: #ecf0f1; border-radius: 8px; }
  #resource-name { margin-top: 15px; font-size: 16px; font-weight: bold; color: #7f8c8d; min-height: 20px; text-align: left; }

  /* Coordinate Display */
  #unit-coords-display-container {
      font-size: 16px;
      font-weight: bold;
      color: #34495e; /* Dark blue-gray color */
      text-align: left;
      padding: 10px;
      background-color: #ecf0f1; /* Light gray background */
      border-radius: 8px;
      margin-bottom: 10px; /* Add spacing below coords */
  }
  #unit-coords-display-container span {
      font-weight: normal; /* Make coords value normal weight */
      color: #2c3e50;
  }

  /* Research Points Display */
  #research-points-display-container {
      font-size: 16px;
      font-weight: bold;
      color: #8e44ad;
      text-align: left;
      padding: 10px;
      background-color: #f3eaf7;
      border-radius: 8px;
      margin-bottom: 0; /* Reset bottom margin */
  }

  /* --- Progress Bars --- */
  .research-progress-container { width: 100%; height: 20px; border: 1px solid #bdc3c7; margin-top: 8px; border-radius: 10px; background-color: #ecf0f1; overflow: hidden; display: none; align-items: center; }
  .research-progress-bar { width: 0%; height: 100%; border-radius: 8px 0 0 8px; transition: width 0.3s ease-in-out; }
  .research-item span { font-size: 12px; margin-left: 5px; color: #555; }
  .research-item p { font-size: 14px; color: #777; margin-top: 5px; margin-bottom: 0; }
   #research-status-display { font-size: 14px; font-weight: bold; color: #27ae60; margin-top: 10px; min-height: 18px; text-align: left; padding: 5px 10px; background-color: #e8f8f5; border-radius: 6px; border: 1px solid #a3e4d7; }

</style>
</head>
<body>
  <!-- Language Switch Button -->
  <div id="language-switcher">
      <button id="language-switch-button" title="Switch Language / Changer de langue"></button>
  </div>

  <h1>Tiny Civilization</h1>
  <div id="unit-display-bar"></div>

  <div id="game-container">
    <!-- === LEFT CONTAINER === -->
    <div id="left-container">
      <div id="colony-name-display">Colony Name</div>
      <div id="inventory"> <!-- Inventory always visible -->
        <h2>Inventory</h2>
        <p>Wood: <span id="wood-count">0</span></p>
        <p>Pebbles: <span id="pebble-count">0</span></p>
        <p>Flint: <span id="flint-count">0</span></p>
        <p>Wheat: <span id="wheat-count">0</span></p>
        <p>Coal: <span id="coal-count">0</span></p>
      </div>
      <button id="action-button" style="display: none;">Gather Resource</button>
      <div id="resource-name"></div>

      <!-- Control Buttons -->
       <button id="research-button">Research</button>
       <button id="buildings-button">Buildings</button>
       <button id="units-button">Units</button>
       <button id="logs-button">Logs</button>
       <button id="save-button">Save Game</button>
       <button id="load-button">Load Game</button>
       <input type="file" id="load-file-input" accept=".json" style="display: none;">

       <!-- Hidden Logs Panel (Stays in Left) -->
       <div id="logs-panel" style="display: none;">
           <h2>Event Logs</h2>
           <input type="text" id="log-search-input" placeholder="Search logs...">
           <div id="log-filter-container">
               <label>
                   <input type="checkbox" id="log-filter-checkbox">
                   Hide gather/cost messages
               </label>
           </div>
           <ul id="logs-list"></ul>
       </div>
    </div>

    <!-- === GRID AREA === -->
    <div id="grid-area">
        <div id="grid" class="grid"></div>
        <div id="alert-message"></div>
    </div>

    <!-- === RIGHT CONTAINER === -->
    <div id="right-panel">
       <!-- Added Coordinate Display -->
       <div id="unit-coords-display-container">
           Coords: <span id="unit-coords">(-, -)</span>
       </div>
       <div id="research-points-display-container">Research Points: <span id="research-points">0</span></div>
       <div id="research-status-display"></div>

       <!-- Hidden Panels (Order Matters for Display) -->
       <div id="tech-tree" style="display: none;">
         <h2>Tech Tree</h2>
         <h3>Primitive Age</h3>
         <ul>
           <li class="research-item">
             <button id="settlement-research">Settlement</button>
             <div id="settlement-research-progress" class="research-progress-container">
               <div id="settlement-research-bar" class="research-progress-bar" style="background-color: #8e44ad;"></div>
             </div>
             <span id="settlement-research-percent">0%</span>
             <p>Unlocks Houses.</p>
           </li>
           <li class="research-item">
             <button id="agriculture-research">Agriculture</button>
             <div id="agriculture-research-progress" class="research-progress-container">
               <div id="agriculture-research-bar" class="research-progress-bar" style="background-color: #aed581;"></div>
             </div>
             <span id="agriculture-research-percent">0%</span>
             <p>Unlocks Farms.</p>
           </li>
           <li class="research-item">
             <button id="mining-research" disabled>Mining</button>
             <div id="mining-research-progress" class="research-progress-container">
               <div id="mining-research-bar" class="research-progress-bar" style="background-color: #7f8c8d;"></div>
             </div>
             <span id="mining-research-percent">0%</span>
             <p>Unlocks Mines (requires Agriculture).</p>
           </li>
         </ul>
       </div>

       <div id="buildings-list" style="display: none;">
           <h2>Buildings</h2>
           <ul></ul>
       </div>

       <div id="units-panel" style="display: none;">
           <h2>Available Units</h2>
           <ul id="units-list">
               <li><button id="deploy-worker-button" disabled>Deploy Worker</button></li>
           </ul>
       </div>

    </div>
  </div>


  <script>
    // --- DOM Element References ---
    const grid = document.getElementById('grid'); const actionButton = document.getElementById('action-button');
    const woodCountDisplay = document.getElementById('wood-count'); const pebbleCountDisplay = document.getElementById('pebble-count'); const flintCountDisplay = document.getElementById('flint-count'); const wheatCountDisplay = document.getElementById('wheat-count'); const coalCountDisplay = document.getElementById('coal-count');
    const inventoryDisplay = document.getElementById('inventory'); const researchButton = document.getElementById('research-button'); const buildingsButton = document.getElementById('buildings-button'); const unitsButton = document.getElementById('units-button'); const logsButton = document.getElementById('logs-button');
    const techTree = document.getElementById('tech-tree'); const buildingsList = document.getElementById('buildings-list'); const unitsPanel = document.getElementById('units-panel'); const unitsList = document.getElementById('units-list'); const logsPanel = document.getElementById('logs-panel'); const logsList = document.getElementById('logs-list');
    const logSearchInput = document.getElementById('log-search-input'); const logFilterCheckbox = document.getElementById('log-filter-checkbox'); const resourceNameDisplay = document.getElementById('resource-name');
    const researchPointsDisplay = document.getElementById('research-points'); const researchStatusDisplay = document.getElementById('research-status-display'); const colonyNameDisplay = document.getElementById('colony-name-display');
    const alertMessageElement = document.getElementById('alert-message'); const unitDisplayBar = document.getElementById('unit-display-bar');
    const unitCoordsDisplay = document.getElementById('unit-coords'); // New ref
    const settlementResearchBtn = document.getElementById('settlement-research'); const settlementResearchProgress = document.getElementById('settlement-research-progress'); const settlementResearchProgressBar = document.getElementById('settlement-research-bar'); const settlementResearchPercent = document.getElementById('settlement-research-percent');
    const agricultureResearchBtn = document.getElementById('agriculture-research'); const agricultureResearchProgress = document.getElementById('agriculture-research-progress'); const agricultureResearchProgressBar = document.getElementById('agriculture-research-bar'); const agricultureResearchPercent = document.getElementById('agriculture-research-percent');
    const miningResearchBtn = document.getElementById('mining-research'); const miningResearchProgress = document.getElementById('mining-research-progress'); const miningResearchProgressBar = document.getElementById('mining-research-bar'); const miningResearchPercent = document.getElementById('mining-research-percent');
    const deployWorkerButton = document.getElementById('deploy-worker-button');
    const saveButton = document.getElementById('save-button');
    const loadButton = document.getElementById('load-button');
    const loadFileInput = document.getElementById('load-file-input');
    const languageSwitchButton = document.getElementById('language-switch-button');


    // --- Game State Variables ---
    const gridSize = 10; // Size of the visible grid
    let units = [];
    let nextUnitId = 0;
    let selectedUnitId = null;
    let inventory = { wood: 0, pebble: 0, flint: 0, wheat: 0, coal: 0 };
    let researchPoints = 0;
    let activeResearch = null;
    let settlementCompleted = false;
    let agricultureCompleted = false;
    let miningCompleted = false;
    let maxWorkers = 0;
    let selectedBuilding = null; // Stores 'house', 'farm', 'mine'
    let moveCount = 0;
    let movesSinceLastCoal = 0;

    // -- World State --
    let viewOffsetX = 0; // World X coordinate of the top-left grid tile
    let viewOffsetY = 0; // World Y coordinate of the top-left grid tile
    let worldData = {}; // Stores generated tile data: { y: { x: { type: 'empty'|'tree'|'stone'|'flint', building: null|'house'|'farm'|'mine' } } }
    let revealedTiles = new Set(); // Stores revealed world coordinates as "x,y" strings

    // -- Other State --
    let colonyName = "New Colony";
    let highlightEnabled = false;
    let alertTimeout;
    let eventLogs = [];
    const maxLogEntries = 50;
    let currentLanguage = 'en';

    // --- Game Constants ---
    const settlementResearchCost = 15; const agricultureResearchCost = 10; const miningResearchCost = 15;
    const houseCost = { wood: 10, pebble: 5 }; const farmCost = { wood: 3 }; const mineCost = { pebble: 5, wood: 2 };
    const wheatProductionInterval = 5; const coalProductionInterval = 7;
    const unitCapabilities = { pawn: { canBuild: ['house'] }, worker: { canBuild: ['farm', 'mine'] } };
    const REVEAL_RADIUS = 2; // How many tiles around a unit are revealed (e.g., 2 = 5x5 area)
    const VIEW_CENTER_OFFSET = Math.floor(gridSize / 2); // = 5 for 10x10 grid

    // --- Translations ---
    const translations = {
        en: {
            // General UI
            gameTitle: "Tiny Civilization",
            switchLanguageTooltip: "Switch Language / Changer de langue",
            switchToFrench: "Français",
            switchToEnglish: "English",
            colonyLabel: "Colony:",
            // Panels & Buttons
            inventoryTitle: "Inventory",
            researchButton: "Research",
            buildingsButton: "Buildings",
            unitsButton: "Units",
            logsButton: "Logs",
            saveButton: "Save Game",
            loadButton: "Load Game",
            // Inventory Items (also used as keys for costs/alerts)
            wood: "Wood",
            pebble: "Pebbles",
            flint: "Flint",
            wheat: "Wheat",
            coal: "Coal",
            // Grid Area
            gatherButton: "Gather Resource",
            noUnitSelected: "No unit selected",
            onTile: "On Tile:",
            emptyTile: "Empty",
            unknownTile: "Unknown", // Added for unrevealed areas
            tileResourceTree: "Tree (Wood)",
            tileResourceStone: "Stone (Pebbles)",
            tileResourceFlint: "Flint",
            // Research Panel
            researchPointsLabel: "Research Points:",
            researchPanelTitle: "Tech Tree",
            primitiveAge: "Primitive Age",
            researchSettlement: "Settlement",
            researchSettlementDesc: "Unlocks Houses.",
            researchAgriculture: "Agriculture",
            researchAgricultureDesc: "Unlocks Farms.",
            researchMining: "Mining",
            researchMiningDesc: "Unlocks Mines (requires Agriculture).",
            researchStatusResearching: "⏳ Researching",
            researchStatusComplete: "✅", // Keep symbols consistent maybe
            researchStatusCompleteSettlement: "Settlement Complete! Houses unlocked.",
            researchStatusCompleteAgriculture: "Agriculture Complete! Farms unlocked.",
            researchStatusCompleteMining: "Mining Complete! Mines unlocked.",
            researchStatusInitial: "Begin your journey! Select units via the top bar and move them on the grid.",
            // Buildings Panel (Keys: buildingHouse, buildingFarm, buildingMine)
            buildingsPanelTitle: "Buildings",
            buildingHouse: "House",
            buildingFarm: "Farm",
            buildingMine: "Mine",
            buildingHouseDesc: "Increases Worker capacity by 1.",
            buildingFarmDesc: "Requires Worker. Produces Wheat over time.",
            buildingMineDesc: "Requires Worker. Produces Coal over time.",
            noBuildingsAvailable: "No buildings available to build yet. Research technology first.",
            // Units Panel (Keys: unitPawn, unitWorker)
            unitsPanelTitle: "Available Units",
            deployWorkerButton: "Deploy Worker",
            deployWorkerRequiresHouse: "Deploy Worker (Requires House)",
            deployWorkerMax: "Max", // As in "(1/2 Max)"
            unitPawn: "Pawn",
            unitWorker: "Worker",
            // Logs Panel
            logsPanelTitle: "Event Logs",
            logSearchPlaceholder: "Search logs...",
            logFilterLabel: "Hide gather/cost messages",
            // Alerts & Prompts (Keys for alerts)
            alertWelcome: "Welcome to {0}!",
            alertGameStarted: "Game started for colony: {0}",
            alertGathered: "Gathered 1 {0}!",
            alertNotEnoughResources: "Not enough resources for {0}!",
            alertCannotBuildEmpty: "Cannot build: Tile is not empty!", // Now checks worldData.type != 'empty'
            alertCannotBuildNonEmpty: "Cannot build: Tile is not empty!", // Generic non-empty reason
            alertCannotBuildExists: "Cannot build: {0} already exists here!", // Checks worldData.building
            alertCannotBuildOnResource: "Cannot build on a {0}!", // Checks worldData.type == resource
            alertBuildSelected: "Selected: {0}. Click an empty tile to build.",
            alertBuildingBuilt: "{0} built!",
            alertSelectUnitToBuild: "No unit selected to perform build action.",
            alertUnitCannotBuild: "{0} cannot build {1}s!",
            alertResearchStarted: "Started researching {0}.",
            alertAlreadyResearching: "Already researching: {0}!",
            alertWorkerDeployed: "Worker deployed!",
            alertMaxWorkers: "Maximum Worker capacity reached. Build more Houses.",
            alertNoSpaceForWorker: "No available space near any House to deploy Worker!",
            alertGameSaved: "Game Saved!",
            alertSaveError: "Error saving game. See console for details.",
            alertLoadSuccess: "Game loaded successfully for colony: {0}!",
            alertLoadError: "Error loading game: {0}.",
            alertLoadInvalidFormat: "Invalid save file format.",
            alertReadFileError: "Error reading file.",
            alertUnitMoveOccupied: "Cannot move unit: Tile is occupied!",
            alertMoveInvalid: "Cannot move there.", // Generic invalid move
            alertSelectedUnit: "Selected Unit: {0} ({1})", // {0}=Type, {1}=ID
            promptColonyName: "Welcome to Tiny Civilization! Please name your colony:",
            defaultColonyName: "New Colony",
            logGameSaved: "Game state saved to file.",
            logNewGame: "New game started for colony:"
        },
        fr: {
            // General UI
            gameTitle: "Mini Civilisation",
            switchLanguageTooltip: "Changer de langue / Switch Language",
            switchToFrench: "Français",
            switchToEnglish: "English",
            colonyLabel: "Colonie :",
            // Panels & Buttons
            inventoryTitle: "Inventaire",
            researchButton: "Recherche",
            buildingsButton: "Bâtiments",
            unitsButton: "Unités",
            logsButton: "Journaux",
            saveButton: "Sauvegarder",
            loadButton: "Charger",
            // Inventory Items (also used as keys for costs/alerts)
            wood: "Bois",
            pebble: "Cailloux",
            flint: "Silex",
            wheat: "Blé",
            coal: "Charbon",
            // Grid Area
            gatherButton: "Récolter Ressource",
            noUnitSelected: "Aucune unité sélectionnée",
            onTile: "Sur la case :",
            emptyTile: "Vide",
            unknownTile: "Inconnu", // Added
            tileResourceTree: "Arbre (Bois)",
            tileResourceStone: "Roche (Cailloux)",
            tileResourceFlint: "Silex",
            // Research Panel
            researchPointsLabel: "Points de Recherche :",
            researchPanelTitle: "Arbre Technologique",
            primitiveAge: "Âge Primitif",
            researchSettlement: "Colonisation",
            researchSettlementDesc: "Débloque les Maisons.",
            researchAgriculture: "Agriculture",
            researchAgricultureDesc: "Débloque les Fermes.",
            researchMining: "Minage",
            researchMiningDesc: "Débloque les Mines (nécessite Agriculture).",
            researchStatusResearching: "⏳ Recherche en cours",
            researchStatusComplete: "✅",
            researchStatusCompleteSettlement: "Colonisation terminée ! Maisons débloquées.",
            researchStatusCompleteAgriculture: "Agriculture terminée ! Fermes débloquées.",
            researchStatusCompleteMining: "Minage terminé ! Mines débloquées.",
            researchStatusInitial: "Commencez votre voyage ! Sélectionnez les unités via la barre supérieure et déplacez-les sur la grille.",
            // Buildings Panel (Keys: buildingHouse, buildingFarm, buildingMine)
            buildingsPanelTitle: "Bâtiments",
            buildingHouse: "Maison",
            buildingFarm: "Ferme",
            buildingMine: "Mine",
            buildingHouseDesc: "Augmente la capacité d'Ouvriers de 1.",
            buildingFarmDesc: "Nécessite Ouvrier. Produit du Blé périodiquement.",
            buildingMineDesc: "Nécessite Ouvrier. Produit du Charbon périodiquement.",
            noBuildingsAvailable: "Aucun bâtiment à construire pour le moment. Recherchez d'abord une technologie.",
            // Units Panel (Keys: unitPawn, unitWorker)
            unitsPanelTitle: "Unités Disponibles",
            deployWorkerButton: "Déployer Ouvrier",
            deployWorkerRequiresHouse: "Déployer Ouvrier (Maison requise)",
            deployWorkerMax: "Max", // As in "(1/2 Max)"
            unitPawn: "Colon",
            unitWorker: "Ouvrier",
            // Logs Panel
            logsPanelTitle: "Journal des Événements",
            logSearchPlaceholder: "Rechercher dans les journaux...",
            logFilterLabel: "Masquer messages récolte/coût",
            // Alerts & Prompts (Keys for alerts)
            alertWelcome: "Bienvenue à {0} !",
            alertGameStarted: "Partie démarrée pour la colonie : {0}",
            alertGathered: "Récolté 1 {0} !",
            alertNotEnoughResources: "Pas assez de ressources pour {0} !",
            alertCannotBuildEmpty: "Construction impossible : La case n'est pas vide !", // Might need review depending on check
            alertCannotBuildNonEmpty: "Construction impossible : La case n'est pas vide !",
            alertCannotBuildExists: "Construction impossible : {0} existe déjà ici !",
            alertCannotBuildOnResource: "Construction impossible sur un(e) {0} !",
            alertBuildSelected: "Sélectionné : {0}. Cliquez une case vide pour construire.",
            alertBuildingBuilt: "{0} construit(e) !",
            alertSelectUnitToBuild: "Aucune unité sélectionnée pour construire.",
            alertUnitCannotBuild: "{0} ne peut pas construire de {1}s !",
            alertResearchStarted: "Recherche commencée pour {0}.",
            alertAlreadyResearching: "Recherche déjà en cours : {0} !",
            alertWorkerDeployed: "Ouvrier déployé !",
            alertMaxWorkers: "Capacité maximale d'Ouvriers atteinte. Construisez plus de Maisons.",
            alertNoSpaceForWorker: "Aucun espace disponible près d'une Maison pour déployer l'Ouvrier !",
            alertGameSaved: "Partie Sauvegardée !",
            alertSaveError: "Erreur lors de la sauvegarde. Voir la console pour détails.",
            alertLoadSuccess: "Partie chargée avec succès pour la colonie : {0} !",
            alertLoadError: "Erreur lors du chargement : {0}.",
            alertLoadInvalidFormat: "Format de sauvegarde invalide.",
            alertReadFileError: "Erreur de lecture du fichier.",
            alertUnitMoveOccupied: "Déplacement impossible : Case occupée !",
            alertMoveInvalid: "Déplacement impossible.",
            alertSelectedUnit: "Unité sélectionnée : {0} ({1})", // {0}=Type, {1}=ID
            promptColonyName: "Bienvenue dans Mini Civilisation ! Veuillez nommer votre colonie :",
            defaultColonyName: "Nouvelle Colonie",
            logGameSaved: "État de la partie sauvegardé dans un fichier.",
            logNewGame: "Nouvelle partie démarrée pour la colonie :"
        }
    };

    // --- Helper Function for Time Formatting ---
    function getFormattedTime() { const now = new Date(); const hours = now.getHours().toString().padStart(2, '0'); const minutes = now.getMinutes().toString().padStart(2, '0'); return `${hours}:${minutes}`; }

    // --- Alert & Logging Function ---
    function showAlert(messageKey, duration = 3000, logMessage = true, args = []) {
        clearTimeout(alertTimeout);
        const lang = translations[currentLanguage];
        let message = lang[messageKey] || messageKey;

        if (args && args.length > 0) {
            args.forEach((arg, index) => {
                const translatedArg = lang[arg] || arg;
                message = message.replace(`{${index}}`, translatedArg);
            });
        }

        if (logMessage) {
            const timeString = getFormattedTime();
            eventLogs.push({ time: timeString, messageKey: messageKey, args: args, rendered: message });
            if (eventLogs.length > maxLogEntries) { eventLogs.shift(); }
            if (logsPanel.style.display === 'block') { updateLogsDisplay(); }
        }

        alertMessageElement.textContent = message;
        alertMessageElement.style.display = 'block';
        requestAnimationFrame(() => { requestAnimationFrame(() => { alertMessageElement.classList.add('show'); }); });
        alertTimeout = setTimeout(() => {
            alertMessageElement.classList.remove('show');
            alertMessageElement.addEventListener('transitionend', function handleTransitionEnd() {
                if (!alertMessageElement.classList.contains('show')) {
                    alertMessageElement.style.display = 'none';
                }
            }, { once: true });
        }, duration);
    }

    // --- Update Logs Display ---
    function updateLogsDisplay() {
        logsList.innerHTML = '';
        const searchTerm = logSearchInput.value.toLowerCase();
        const hideFilteredMessages = logFilterCheckbox.checked;
        const lang = translations[currentLanguage];

        const filteredLogs = eventLogs.filter(log => {
            let messageToSearch = log.rendered || log.message;
            if(log.messageKey && !log.rendered) {
                 messageToSearch = lang[log.messageKey] || log.messageKey;
                 if (log.args && log.args.length > 0) {
                    log.args.forEach((arg, index) => {
                        const translatedArg = lang[arg] || arg;
                        messageToSearch = messageToSearch.replace(`{${index}}`, translatedArg);
                    });
                 }
                 log.rendered = messageToSearch;
            }

            const messageLower = messageToSearch.toLowerCase();
            const searchMatch = messageLower.includes(searchTerm);
            if (!searchMatch) return false;

            if (hideFilteredMessages) {
                const isGather = log.messageKey === 'alertGathered';
                const isCost = log.messageKey === 'alertNotEnoughResources';
                 if (isGather || isCost) { return false; }
            }
            return true;
        });

        for (let i = filteredLogs.length - 1; i >= 0; i--) {
            const log = filteredLogs[i];
            const logEntry = document.createElement('li');
            const timeSpan = document.createElement('span');
            timeSpan.className = 'log-time';
            timeSpan.textContent = `[${log.time}]`;
            const messageText = document.createTextNode(` ${log.rendered || log.message}`);
            logEntry.appendChild(timeSpan);
            logEntry.appendChild(messageText);
            logsList.appendChild(logEntry);
        }
    }

    // --- Initialization Functions ---
    function initializeGridDOM() {
        grid.innerHTML = '';
        for (let gy = 0; gy < gridSize; gy++) {
            for (let gx = 0; gx < gridSize; gx++) {
                const tile = document.createElement('div');
                tile.classList.add('tile');
                tile.dataset.gridX = gx;
                tile.dataset.gridY = gy;
                grid.appendChild(tile);
            }
        }
    }

    // --- World Generation ---
    function getTileData(worldX, worldY) { return worldData[worldY]?.[worldX]; }
    function setTileData(worldX, worldY, data) { if (!worldData[worldY]) { worldData[worldY] = {}; } worldData[worldY][worldX] = data; }

    function generateTileContent(worldX, worldY) {
        const coordString = `${worldX},${worldY}`;
        if (revealedTiles.has(coordString)) { return getTileData(worldX, worldY); }
        revealedTiles.add(coordString);
        let type = 'empty';
        const rand = Math.random();
        if (rand < 0.08) { type = 'tree'; }
        else if (rand < 0.13) { type = 'stone'; }
        else if (rand < 0.16) { type = 'flint'; }
        const data = { type: type, building: null };
        setTileData(worldX, worldY, data);
        return data;
    }

    function revealArea(centerX, centerY, radius) {
        let newlyRevealed = false;
        for (let dy = -radius; dy <= radius; dy++) {
            for (let dx = -radius; dx <= radius; dx++) {
                 const wx = centerX + dx; const wy = centerY + dy;
                 const coordString = `${wx},${wy}`;
                 if (!revealedTiles.has(coordString)) { generateTileContent(wx, wy); newlyRevealed = true; }
            }
        }
        return newlyRevealed;
    }

    // --- Update Functions ---
    function updateGrid() {
        const tiles = grid.querySelectorAll('.tile');
        const lang = translations[currentLanguage];
        tiles.forEach(tile => {
            const gx = parseInt(tile.dataset.gridX); const gy = parseInt(tile.dataset.gridY);
            const worldX = gx + viewOffsetX; const worldY = gy + viewOffsetY;
            const coordString = `${worldX},${worldY}`;
            const existingMarker = tile.querySelector('.unit-marker');
            if (existingMarker) existingMarker.remove();
            tile.className = 'tile'; tile.textContent = ''; tile.classList.remove('highlight');
            if (revealedTiles.has(coordString)) {
                const data = getTileData(worldX, worldY); let tileTitle = lang.emptyTile;
                if (data) {
                    tile.classList.add(data.type);
                    if (data.building) {
                        tile.classList.add(data.building); tile.textContent = data.building.substring(0, 4).toUpperCase();
                        tileTitle = lang[`building${data.building.charAt(0).toUpperCase() + data.building.slice(1)}`] || data.building;
                    } else if (data.type !== 'empty') {
                         let resourceKey = '';
                         if (data.type === 'tree') resourceKey = 'tileResourceTree'; else if (data.type === 'stone') resourceKey = 'tileResourceStone'; else if (data.type === 'flint') resourceKey = 'tileResourceFlint';
                         tileTitle = lang[resourceKey] || data.type;
                    }
                } else { tile.classList.add('empty'); tileTitle = lang.emptyTile; }
                 tile.title = tileTitle;
            } else { tile.classList.add('unknown'); tile.title = lang.unknownTile; }
        });
        units.forEach(unit => {
            const unitGridX = unit.worldX - viewOffsetX; const unitGridY = unit.worldY - viewOffsetY;
            if (unitGridX >= 0 && unitGridX < gridSize && unitGridY >= 0 && unitGridY < gridSize) {
                const tile = grid.querySelector(`.tile[data-grid-x="${unitGridX}"][data-grid-y="${unitGridY}"]`);
                if (tile && !tile.classList.contains('unknown')) {
                    const marker = document.createElement('div'); marker.classList.add('unit-marker', unit.type);
                    const unitTypeKey = `unit${unit.type.charAt(0).toUpperCase() + unit.type.slice(1)}`;
                    const translatedUnitType = lang[unitTypeKey] || unit.type;
                    marker.textContent = translatedUnitType.charAt(0).toUpperCase();
                    if (unit.id === selectedUnitId) { marker.classList.add('selected'); }
                    tile.appendChild(marker);
                    tile.title = `${translatedUnitType} (${unit.id}) - ${tile.title}`;
                }
            }
        });
        const selectedUnit = units.find(u => u.id === selectedUnitId);
        if (highlightEnabled && selectedUnit) {
            const unitGridX = selectedUnit.worldX - viewOffsetX; const unitGridY = selectedUnit.worldY - viewOffsetY;
            if (unitGridX >= 0 && unitGridX < gridSize && unitGridY >= 0 && unitGridY < gridSize) {
                tiles.forEach(tile => {
                    const targetGridX = parseInt(tile.dataset.gridX); const targetGridY = parseInt(tile.dataset.gridY);
                    const dx = Math.abs(targetGridX - unitGridX); const dy = Math.abs(targetGridY - unitGridY);
                    if (dx <= 1 && dy <= 1 && !(dx === 0 && dy === 0) && !tile.classList.contains('unknown')) {
                        const targetWorldX = targetGridX + viewOffsetX; const targetWorldY = targetGridY + viewOffsetY;
                        const targetOccupied = units.some(u => u.worldX === targetWorldX && u.worldY === targetWorldY && u.id !== selectedUnitId);
                        if (!targetOccupied) { tile.classList.add('highlight'); }
                    }
                });
            }
        }
        checkResource(); // Check resource after every grid update
    }

    function updateInventoryDisplay() { /* ... no changes ... */ woodCountDisplay.textContent = inventory.wood; pebbleCountDisplay.textContent = inventory.pebble; flintCountDisplay.textContent = inventory.flint; wheatCountDisplay.textContent = inventory.wheat; coalCountDisplay.textContent = inventory.coal; }
    function updateResearchPointsDisplay() { /* ... no changes ... */ researchPointsDisplay.textContent = researchPoints; }

    function updateUnitCoordsDisplay() { // NEW function
        const selectedUnit = units.find(u => u.id === selectedUnitId);
        if (selectedUnit) {
            unitCoordsDisplay.textContent = `(${selectedUnit.worldX}, ${selectedUnit.worldY})`;
        } else {
            unitCoordsDisplay.textContent = `(-, -)`;
        }
    }

    function updateResearchProgress() { /* ... no changes needed ... */
        let statusMsg = researchStatusDisplay.textContent || ""; let researchCompletedThisTurn = false; const lang = translations[currentLanguage];
        function formatProgress(researchKeyBase, currentPoints, cost) { const researchKey = `research${researchKeyBase.charAt(0).toUpperCase() + researchKeyBase.slice(1)}`; const progress = Math.min(100, cost > 0 ? (currentPoints / cost) * 100 : 100); const researchName = lang[researchKey] || researchKeyBase; return `${lang.researchStatusResearching} ${researchName}... ${Math.floor(progress)}%`; }
        function updateProgressBar(progressBar, percentDisplay, progressContainer, progress) { progressBar.style.width = progress + '%'; percentDisplay.textContent = Math.floor(progress) + '%'; progressContainer.style.display = 'flex'; }
        function handleCompletion(researchKeyBase, completionFlag, progressContainer, buttonElement, nextButtonElement = null) { const completionKey = `researchStatusComplete${researchKeyBase.charAt(0).toUpperCase() + researchKeyBase.slice(1)}`; activeResearch = null; researchPoints = 0; progressContainer.style.display = 'none'; buttonElement.disabled = true; statusMsg = `${lang.researchStatusComplete} ${lang[completionKey]}`; showAlert(completionKey, 3500); researchCompletedThisTurn = true; if (nextButtonElement) { const nextResearchKey = nextButtonElement.id.replace('-research', ''); const nextCompletionFlagName = `${nextResearchKey}Completed`; if (!window[nextCompletionFlagName]) { nextButtonElement.disabled = false; } } return true; }
        if (activeResearch === 'settlement') { const progress = Math.min(100, settlementResearchCost > 0 ? (researchPoints / settlementResearchCost) * 100 : 100); updateProgressBar(settlementResearchProgressBar, settlementResearchPercent, settlementResearchProgress, progress); if (researchPoints >= settlementResearchCost && !settlementCompleted) { settlementCompleted = handleCompletion('Settlement', settlementCompleted, settlementResearchProgress, settlementResearchBtn); } else if (activeResearch === 'settlement') { statusMsg = formatProgress('settlement', researchPoints, settlementResearchCost); } }
        else if (activeResearch === 'agriculture') { const progress = Math.min(100, agricultureResearchCost > 0 ? (researchPoints / agricultureResearchCost) * 100 : 100); updateProgressBar(agricultureResearchProgressBar, agricultureResearchPercent, agricultureResearchProgress, progress); if (researchPoints >= agricultureResearchCost && !agricultureCompleted) { agricultureCompleted = handleCompletion('Agriculture', agricultureCompleted, agricultureResearchProgress, agricultureResearchBtn, miningResearchBtn); } else if (activeResearch === 'agriculture') { statusMsg = formatProgress('agriculture', researchPoints, agricultureResearchCost); } }
        else if (activeResearch === 'mining') { const progress = Math.min(100, miningResearchCost > 0 ? (researchPoints / miningResearchCost) * 100 : 100); updateProgressBar(miningResearchProgressBar, miningResearchPercent, miningResearchProgress, progress); if (researchPoints >= miningResearchCost && !miningCompleted) { miningCompleted = handleCompletion('Mining', miningCompleted, miningResearchProgress, miningResearchBtn); } else if (activeResearch === 'mining') { statusMsg = formatProgress('mining', researchPoints, miningResearchCost); } }
        else { settlementResearchProgress.style.display = 'none'; agricultureResearchProgress.style.display = 'none'; miningResearchProgress.style.display = 'none'; if (!researchCompletedThisTurn && !statusMsg.startsWith(lang.researchStatusComplete)) { const isCompletionMsg = statusMsg === `${lang.researchStatusComplete} ${lang.researchStatusCompleteSettlement}` || statusMsg === `${lang.researchStatusComplete} ${lang.researchStatusCompleteAgriculture}` || statusMsg === `${lang.researchStatusComplete} ${lang.researchStatusCompleteMining}`; if (!isCompletionMsg) { const initialMsg = lang.researchStatusInitial || ""; statusMsg = researchStatusDisplay.textContent.startsWith(initialMsg) ? researchStatusDisplay.textContent : ""; } } }
        if (researchCompletedThisTurn) { updateBuildingsList(); updateUnitsPanel(); updateResearchPointsDisplay(); }
        if (researchStatusDisplay.textContent !== statusMsg || statusMsg.startsWith(lang.researchStatusComplete) || statusMsg === "" || statusMsg.startsWith(lang.researchStatusInitial)) { researchStatusDisplay.textContent = statusMsg; }
        researchStatusDisplay.style.display = statusMsg ? 'block' : 'none';
    }

    function updateBuildingsList() { /* ... no changes ... */
        const buildingsListElement = buildingsList.querySelector('ul'); buildingsListElement.innerHTML = ''; const lang = translations[currentLanguage];
        function addBuildingOption(buildingKey, cost, costCheckFn) { const buildingName = lang[buildingKey] || buildingKey.replace('building',''); const descriptionText = lang[`${buildingKey}Desc`] || ""; const costString = Object.entries(cost).map(([resKey, amount]) => `${amount} ${lang[resKey] || resKey}`).join(', '); const listItem = document.createElement('li'); const button = document.createElement('button'); button.textContent = `${buildingName} (${costString})`; const buildingTypeSimple = buildingKey.replace('building','').toLowerCase(); button.dataset.building = buildingTypeSimple; button.addEventListener('click', () => { if (costCheckFn()) { selectedBuilding = buildingTypeSimple; showAlert('alertBuildSelected', 4000, true, [buildingKey]); } else { showAlert('alertNotEnoughResources', 3000, true, [buildingKey]); } }); listItem.appendChild(button); const description = document.createElement('p'); description.textContent = descriptionText; description.style.fontSize = '12px'; description.style.color = '#666'; description.style.marginTop = '4px'; listItem.appendChild(description); buildingsListElement.appendChild(listItem); }
        if (settlementCompleted) { addBuildingOption('buildingHouse', houseCost, () => inventory.wood >= houseCost.wood && inventory.pebble >= houseCost.pebble); }
        if (agricultureCompleted) { addBuildingOption('buildingFarm', farmCost, () => inventory.wood >= farmCost.wood); }
        if (miningCompleted) { addBuildingOption('buildingMine', mineCost, () => inventory.pebble >= mineCost.pebble && inventory.wood >= mineCost.wood); }
        if (buildingsListElement.innerHTML === '') { buildingsListElement.innerHTML = `<li>${lang.noBuildingsAvailable}</li>`; }
    }
    function updateUnitDisplayBar() { /* ... no changes ... */
        unitDisplayBar.innerHTML = ''; const lang = translations[currentLanguage]; units.forEach(unit => { const icon = document.createElement('div'); icon.classList.add('unit-icon'); icon.dataset.unitId = unit.id; icon.dataset.unitType = unit.type; const unitTypeKey = `unit${unit.type.charAt(0).toUpperCase() + unit.type.slice(1)}`; const translatedUnitType = lang[unitTypeKey] || unit.type; icon.textContent = translatedUnitType.charAt(0).toUpperCase(); icon.title = `${translatedUnitType} (${unit.id})`; if (unit.id === selectedUnitId) { icon.classList.add('selected'); } icon.addEventListener('click', () => { selectedUnitId = unit.id; focusOnUnit(unit.id); }); unitDisplayBar.appendChild(icon); });
    }
    function updateUnitsPanel() { /* ... no changes ... */
        const currentWorkers = units.filter(u => u.type === 'worker').length; const lang = translations[currentLanguage]; let buttonText = lang.deployWorkerButton; let isDisabled = false; if (!settlementCompleted) { isDisabled = true; } else if (maxWorkers <= 0) { isDisabled = true; buttonText = lang.deployWorkerRequiresHouse; } else if (currentWorkers >= maxWorkers) { isDisabled = true; buttonText = `${lang.deployWorkerButton} (${currentWorkers}/${maxWorkers} ${lang.deployWorkerMax})`; } else { isDisabled = false; buttonText = `${lang.deployWorkerButton} (${currentWorkers}/${maxWorkers})`; } deployWorkerButton.disabled = isDisabled; deployWorkerButton.textContent = buttonText; const workerLi = unitsList.querySelector('li'); if (workerLi) { workerLi.innerHTML = ''; workerLi.appendChild(deployWorkerButton); } else { const newLi = document.createElement('li'); newLi.appendChild(deployWorkerButton); unitsList.appendChild(newLi); }
    }

    // --- Gameplay Functions ---
    function checkResource() { /* ... no changes ... */
        const selectedUnit = units.find(u => u.id === selectedUnitId); let canGather = false; let tileInfo = null; if (selectedUnit) { const unitWorldX = selectedUnit.worldX; const unitWorldY = selectedUnit.worldY; const data = getTileData(unitWorldX, unitWorldY); tileInfo = data; if (data && !data.building) { if (data.type === 'tree' || data.type === 'stone' || data.type === 'flint') { canGather = true; } } } actionButton.style.display = canGather ? 'inline-block' : 'none'; displayTileInfo(selectedUnit, tileInfo);
    }
    function displayTileInfo(unit, tileData) { /* ... no changes ... */
        const lang = translations[currentLanguage]; if (!unit) { resourceNameDisplay.textContent = lang.noUnitSelected; return; } let nameToShow = lang.unknownTile; if (tileData) { if (tileData.building) { const buildingKey = `building${tileData.building.charAt(0).toUpperCase() + tileData.building.slice(1)}`; nameToShow = `${lang.onTile} ${lang[buildingKey] || tileData.building}`; } else if (tileData.type === 'tree') { nameToShow = `${lang.onTile} ${lang.tileResourceTree}`; } else if (tileData.type === 'stone') { nameToShow = `${lang.onTile} ${lang.tileResourceStone}`; } else if (tileData.type === 'flint') { nameToShow = `${lang.onTile} ${lang.tileResourceFlint}`; } else { nameToShow = `${lang.onTile} ${lang.emptyTile}`; } } resourceNameDisplay.textContent = nameToShow;
    }

    function moveUnit(targetGridX, targetGridY) { // <<< MODIFIED
        const selectedUnit = units.find(u => u.id === selectedUnitId);
        if (!selectedUnit) return;

        const targetWorldX = targetGridX + viewOffsetX;
        const targetWorldY = targetGridY + viewOffsetY;

        // Validation
        const dx = Math.abs(targetWorldX - selectedUnit.worldX); const dy = Math.abs(targetWorldY - selectedUnit.worldY);
        if (!(dx <= 1 && dy <= 1 && (dx !== 0 || dy !== 0))) { return; } // Not adjacent
        if (!revealedTiles.has(`${targetWorldX},${targetWorldY}`)) { return; } // Not revealed
        const targetOccupied = units.some(u => u.worldX === targetWorldX && u.worldY === targetWorldY && u.id !== selectedUnitId);
        if (targetOccupied) { showAlert("alertUnitMoveOccupied", 2000, false); return; }

        // Execute Move
        selectedUnit.worldX = targetWorldX;
        selectedUnit.worldY = targetWorldY;

        // Reveal & Update Progress
        revealArea(targetWorldX, targetWorldY, REVEAL_RADIUS);
        if (activeResearch) { researchPoints++; updateResearchPointsDisplay(); updateResearchProgress(); }
        moveCount++; movesSinceLastCoal++;
        if (moveCount >= wheatProductionInterval) { produceWheat(); moveCount = 0; }
        if (movesSinceLastCoal >= coalProductionInterval) { produceCoal(); movesSinceLastCoal = 0; }

        // Update View and Check Resources
        const unitStillSelected = selectedUnit.id === selectedUnitId;
        if (unitStillSelected) {
            // <<<< FOCUS on the selected unit after move >>>>
            focusOnUnit(selectedUnit.id);
        } else {
            // Fallback (unlikely scenario)
            updateGrid();
        }
    }

    function gatherResource() { /* ... no changes ... */
        const selectedUnit = units.find(u => u.id === selectedUnitId); if (!selectedUnit) { showAlert("noUnitSelected", 2000); return; } const unitWorldX = selectedUnit.worldX; const unitWorldY = selectedUnit.worldY; const data = getTileData(unitWorldX, unitWorldY); if (data && !data.building) { let gatheredResourceKey = ''; if (data.type === 'tree') { inventory.wood++; gatheredResourceKey = 'wood'; data.type = 'empty'; } else if (data.type === 'stone') { inventory.pebble++; gatheredResourceKey = 'pebble'; data.type = 'empty'; } else if (data.type === 'flint') { inventory.flint++; gatheredResourceKey = 'flint'; data.type = 'empty'; } if (gatheredResourceKey) { showAlert('alertGathered', 1500, true, [gatheredResourceKey]); setTileData(unitWorldX, unitWorldY, data); updateInventoryDisplay(); updateGrid(); } }
    }
    function produceWheat() { /* ... no changes ... */ let wheatProduced = 0; revealedTiles.forEach(coordString => { const [x, y] = coordString.split(',').map(Number); const data = getTileData(x, y); if (data && data.building === 'farm') { wheatProduced++; } }); if (wheatProduced > 0) { inventory.wheat += wheatProduced; updateInventoryDisplay(); } }
    function produceCoal() { /* ... no changes ... */ let coalProduced = 0; revealedTiles.forEach(coordString => { const [x, y] = coordString.split(',').map(Number); const data = getTileData(x, y); if (data && data.building === 'mine') { coalProduced++; } }); if (coalProduced > 0) { inventory.coal += coalProduced; updateInventoryDisplay(); } }
    function findSpawnPointNearHouse() { /* ... no changes ... */
         const workers = units.filter(u => u.type === 'worker'); if (workers.length === 0 && units.length > 0) { const pawn = units[0]; for (let dy = -1; dy <= 1; dy++) { for (let dx = -1; dx <= 1; dx++) { if (dx === 0 && dy === 0) continue; const sx = pawn.worldX + dx; const sy = pawn.worldY + dy; const sData = getTileData(sx, sy); if (revealedTiles.has(`${sx},${sy}`) && sData && sData.type === 'empty' && !sData.building && !units.some(u => u.worldX === sx && u.worldY === sy)) { return { worldX: sx, worldY: sy }; } } } return null; } const houseCoords = []; revealedTiles.forEach(coordString => { const [x, y] = coordString.split(',').map(Number); const data = getTileData(x,y); if(data && data.building === 'house') { houseCoords.push({worldX: x, worldY: y}); } }); if (houseCoords.length === 0) return null; for (const houseCoord of houseCoords) { for (let dy = -1; dy <= 1; dy++) { for (let dx = -1; dx <= 1; dx++) { if (dx === 0 && dy === 0) continue; const sx = houseCoord.worldX + dx; const sy = houseCoord.worldY + dy; const sData = getTileData(sx, sy); if (revealedTiles.has(`${sx},${sy}`) && sData && sData.type === 'empty' && !sData.building && !units.some(u => u.worldX === sx && u.worldY === sy)) { return { worldX: sx, worldY: sy }; } } } } return null;
    }

    // --- Unit Focusing ---
    function focusOnUnit(unitId) { // <<< MODIFIED (call updateUnitCoordsDisplay)
        const unit = units.find(u => u.id === unitId);
        if (!unit) return;

        const newViewOffsetX = unit.worldX - VIEW_CENTER_OFFSET;
        const newViewOffsetY = unit.worldY - VIEW_CENTER_OFFSET;
        const viewChanged = newViewOffsetX !== viewOffsetX || newViewOffsetY !== viewOffsetY;

        viewOffsetX = newViewOffsetX; viewOffsetY = newViewOffsetY;

        let newlyRevealed = false;
        for (let gy = 0; gy < gridSize; gy++) {
            for (let gx = 0; gx < gridSize; gx++) {
                if(revealArea(gx + viewOffsetX, gy + viewOffsetY, 0)) { newlyRevealed = true; }
            }
        }

        selectedUnitId = unitId;
        updateUnitDisplayBar();
        updateUnitCoordsDisplay(); // <<< UPDATE COORDS DISPLAY

        if (viewChanged || newlyRevealed) {
            updateGrid(); // This calls checkResource
        } else {
            updateGrid(); // Redraw needed for selection highlight update
        }
    }


    // --- Event Listeners ---
    grid.addEventListener('click', (event) => { /* ... no changes ... */
        if (event.target.classList.contains('tile') && !event.target.classList.contains('unknown')) {
            const gridX = parseInt(event.target.dataset.gridX); const gridY = parseInt(event.target.dataset.gridY); const worldX = gridX + viewOffsetX; const worldY = gridY + viewOffsetY;
            const clickedUnit = units.find(u => u.worldX === worldX && u.worldY === worldY); const lang = translations[currentLanguage];
            if (clickedUnit) { selectedUnitId = clickedUnit.id; selectedBuilding = null; updateUnitDisplayBar(); updateGrid(); const unitTypeKey = `unit${clickedUnit.type.charAt(0).toUpperCase() + clickedUnit.type.slice(1)}`; showAlert('alertSelectedUnit', 1500, false, [unitTypeKey, clickedUnit.id]); }
            else if (selectedBuilding) { const builderUnit = units.find(u => u.id === selectedUnitId); if (!builderUnit) { showAlert("alertSelectUnitToBuild", 2500); selectedBuilding = null; return; } const tileData = getTileData(worldX, worldY); if (tileData && tileData.type === 'empty' && !tileData.building) { const capabilities = unitCapabilities[builderUnit.type]; const buildingKey = `building${selectedBuilding.charAt(0).toUpperCase() + selectedBuilding.slice(1)}`; if (!capabilities || !capabilities.canBuild.includes(selectedBuilding)) { const unitTypeKey = `unit${builderUnit.type.charAt(0).toUpperCase() + builderUnit.type.slice(1)}`; showAlert('alertUnitCannotBuild', 3000, true, [unitTypeKey, buildingKey]); selectedBuilding = null; return; } let costMet = false; let cost; if (selectedBuilding === 'house') { cost = houseCost; if (inventory.wood >= cost.wood && inventory.pebble >= cost.pebble) { inventory.wood -= cost.wood; inventory.pebble -= cost.pebble; costMet = true; maxWorkers++; updateUnitsPanel(); } } else if (selectedBuilding === 'farm') { cost = farmCost; if (inventory.wood >= cost.wood) { inventory.wood -= cost.wood; costMet = true; } } else if (selectedBuilding === 'mine') { cost = mineCost; if (inventory.pebble >= cost.pebble && inventory.wood >= cost.wood) { inventory.pebble -= cost.pebble; inventory.wood -= cost.wood; costMet = true; } } if(costMet) { tileData.building = selectedBuilding; setTileData(worldX, worldY, tileData); showAlert('alertBuildingBuilt', 2500, true, [buildingKey]); selectedBuilding = null; updateInventoryDisplay(); updateGrid(); updateBuildingsList(); } else { showAlert('alertNotEnoughResources', 3000, true, [buildingKey]); selectedBuilding = null; } } else { let reasonKey = 'alertCannotBuildNonEmpty'; let reasonArgs = []; if (tileData && tileData.building) { reasonKey = 'alertCannotBuildExists'; reasonArgs = [`building${tileData.building.charAt(0).toUpperCase() + tileData.building.slice(1)}`]; } else if (tileData && tileData.type !== 'empty') { let resourceNameKey = ''; if (tileData.type === 'tree') resourceNameKey = 'tileResourceTree'; else if (tileData.type === 'stone') resourceNameKey = 'tileResourceStone'; else if (tileData.type === 'flint') resourceNameKey = 'tileResourceFlint'; reasonKey = 'alertCannotBuildOnResource'; reasonArgs = [resourceNameKey || tileData.type]; } showAlert(reasonKey, 3000, true, reasonArgs); selectedBuilding = null; } }
            else { moveUnit(gridX, gridY); }
        }
    });
    actionButton.addEventListener('click', gatherResource);

    // --- Panel Toggling ---
    function hideAllPanels() { /* ... no changes ... */ techTree.style.display = 'none'; buildingsList.style.display = 'none'; unitsPanel.style.display = 'none'; logsPanel.style.display = 'none'; }
    researchButton.addEventListener('click', () => { /* ... no changes ... */ const isVisible = techTree.style.display === 'block'; hideAllPanels(); if (!isVisible) techTree.style.display = 'block'; });
    buildingsButton.addEventListener('click', () => { /* ... no changes ... */ const isVisible = buildingsList.style.display === 'block'; hideAllPanels(); if (!isVisible) { updateBuildingsList(); buildingsList.style.display = 'block'; } });
    unitsButton.addEventListener('click', () => { /* ... no changes ... */ const isVisible = unitsPanel.style.display === 'block'; hideAllPanels(); if (!isVisible) { updateUnitsPanel(); unitsPanel.style.display = 'block'; } });
    logsButton.addEventListener('click', () => { /* ... no changes ... */ const isVisible = logsPanel.style.display === 'block'; hideAllPanels(); if (!isVisible) { updateLogsDisplay(); logsPanel.style.display = 'block'; } });

    // --- Log Filter/Search Listeners ---
    logSearchInput.addEventListener('input', updateLogsDisplay);
    logFilterCheckbox.addEventListener('change', updateLogsDisplay);

    // --- Research Button Listeners ---
    function handleResearchClick(researchType, buttonElement, completionFlag, progressContainer) { /* ... no changes ... */ const researchKey = `research${researchType.charAt(0).toUpperCase() + researchType.slice(1)}`; if (buttonElement.disabled || completionFlag) return; if (!activeResearch) { activeResearch = researchType.toLowerCase(); progressContainer.style.display = 'flex'; updateResearchPointsDisplay(); updateResearchProgress(); showAlert("alertResearchStarted", 2500, true, [researchKey]); } else { const activeResearchKey = `research${activeResearch.charAt(0).toUpperCase() + activeResearch.slice(1)}`; showAlert("alertAlreadyResearching", 3000, true, [activeResearchKey]); } }
    settlementResearchBtn.addEventListener('click', () => handleResearchClick('Settlement', settlementResearchBtn, settlementCompleted, settlementResearchProgress));
    agricultureResearchBtn.addEventListener('click', () => handleResearchClick('Agriculture', agricultureResearchBtn, agricultureCompleted, agricultureResearchProgress));
    miningResearchBtn.addEventListener('click', () => handleResearchClick('Mining', miningResearchBtn, miningCompleted, miningResearchProgress));

    // --- Deploy Worker Listener ---
    deployWorkerButton.addEventListener('click', () => { /* ... no changes ... */ if (deployWorkerButton.disabled) return; const spawnDetails = findSpawnPointNearHouse(); if (spawnDetails) { const newWorker = { id: `unit-${nextUnitId++}`, type: 'worker', worldX: spawnDetails.worldX, worldY: spawnDetails.worldY }; units.push(newWorker); revealArea(newWorker.worldX, newWorker.worldY, REVEAL_RADIUS); showAlert("alertWorkerDeployed", 2000); updateGrid(); updateUnitDisplayBar(); updateUnitsPanel(); } else { showAlert("alertNoSpaceForWorker", 3000); } });

    // --- Grid Hover Highlights ---
    grid.addEventListener('mouseover', (event) => { /* ... no changes ... */ if (event.target.classList.contains('tile') && !event.target.classList.contains('unknown') && !selectedBuilding && selectedUnitId != null) { highlightEnabled = true; updateGrid(); } });
    grid.addEventListener('mouseout', (event) => { /* ... no changes ... */ if (highlightEnabled && (!event.relatedTarget || !event.relatedTarget.closest || !event.relatedTarget.closest('#grid'))) { highlightEnabled = false; updateGrid(); } });

    // --- Save/Load Functions ---
    function gatherSaveData() { /* ... no changes ... */ return { units: units, nextUnitId: nextUnitId, selectedUnitId: selectedUnitId, inventory: inventory, researchPoints: researchPoints, activeResearch: activeResearch, settlementCompleted: settlementCompleted, agricultureCompleted: agricultureCompleted, miningCompleted: miningCompleted, maxWorkers: maxWorkers, moveCount: moveCount, movesSinceLastCoal: movesSinceLastCoal, colonyName: colonyName, currentLanguage: currentLanguage, eventLogs: eventLogs.map(log => ({ time: log.time, messageKey: log.messageKey || null, args: log.args || [] })), viewOffsetX: viewOffsetX, viewOffsetY: viewOffsetY, worldData: worldData, revealedTiles: Array.from(revealedTiles) }; }
    function saveGame() { /* ... no changes ... */ try { const saveData = gatherSaveData(); const saveDataJson = JSON.stringify(saveData); const blob = new Blob([saveDataJson], { type: 'application/json' }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; const safeColonyName = colonyName.replace(/[^a-z0-9]/gi, '_').toLowerCase(); link.download = `tinyciv_${safeColonyName}_save.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); showAlert('alertGameSaved', 2000); const timeString = getFormattedTime(); eventLogs.push({ time: timeString, messageKey: 'logGameSaved', args: [], rendered: translations[currentLanguage].logGameSaved }); if (logsPanel.style.display === 'block') { updateLogsDisplay(); } } catch (error) { console.error("Error saving game:", error); if (error instanceof RangeError) { showAlert('alertSaveError', 6000, true, ["Save data too large!"]); } else { showAlert('alertSaveError', 4000); } } }

    function applyLoadedData(data) { // <<< MODIFIED (call updateUnitCoordsDisplay)
        // Restore basic state
        units = data.units || []; nextUnitId = data.nextUnitId || 0;
        inventory = data.inventory || { wood: 0, pebble: 0, flint: 0, wheat: 0, coal: 0 };
        researchPoints = data.researchPoints || 0; activeResearch = data.activeResearch || null;
        settlementCompleted = data.settlementCompleted || false; agricultureCompleted = data.agricultureCompleted || false; miningCompleted = data.miningCompleted || false;
        maxWorkers = data.maxWorkers || 0; moveCount = data.moveCount || 0; movesSinceLastCoal = data.movesSinceLastCoal || 0;
        colonyName = data.colonyName || "Loaded Colony"; currentLanguage = data.currentLanguage || 'en';
        // Restore world state
        viewOffsetX = data.viewOffsetX || 0; viewOffsetY = data.viewOffsetY || 0;
        worldData = data.worldData || {}; revealedTiles = new Set(data.revealedTiles || []);
        selectedUnitId = data.selectedUnitId !== undefined ? data.selectedUnitId : (units.length > 0 ? units[0].id : null);

         // Restore logs and render messages
         eventLogs = (data.eventLogs || []).map(log => {
             let renderedMessage = translations[currentLanguage][log.messageKey] || log.messageKey || "?";
             if (log.args && log.args.length > 0) {
                 log.args.forEach((arg, index) => {
                     const translatedArg = translations[currentLanguage][arg] || arg;
                     renderedMessage = renderedMessage.replace(`{${index}}`, translatedArg);
                 });
             }
             return { time: log.time, messageKey: log.messageKey, args: log.args, rendered: renderedMessage };
         });

        // Refresh UI
        selectedBuilding = null; highlightEnabled = false; hideAllPanels();
        updateLanguageUI(); // Updates static text first
        updateInventoryDisplay(); updateResearchPointsDisplay();
        updateUnitDisplayBar();
        updateUnitCoordsDisplay(); // <<< UPDATE COORDS
        updateGrid(); // Draw loaded view
        updateResearchProgress(); updateBuildingsList(); updateUnitsPanel();

        // Set button states
        settlementResearchBtn.disabled = settlementCompleted || !!activeResearch;
        agricultureResearchBtn.disabled = agricultureCompleted || !!activeResearch;
        miningResearchBtn.disabled = miningCompleted || !agricultureCompleted || !!activeResearch;

        showAlert('alertLoadSuccess', 3000, false, [colonyName]);
    }
    function loadGame(event) { /* ... no changes ... */ const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const fileContent = e.target.result; const loadedData = JSON.parse(fileContent); if (!loadedData || typeof loadedData.colonyName === 'undefined' || typeof loadedData.units === 'undefined' || typeof loadedData.worldData === 'undefined') { throw new Error(translations[currentLanguage].alertLoadInvalidFormat); } applyLoadedData(loadedData); } catch (error) { console.error("Error loading game:", error); showAlert('alertLoadError', 5000, true, [error.message]); } finally { loadFileInput.value = null; } }; reader.onerror = function() { showAlert('alertReadFileError', 3000); loadFileInput.value = null; }; reader.readAsText(file); }

    // --- Event Listeners for Save/Load ---
    saveButton.addEventListener('click', saveGame);
    loadButton.addEventListener('click', () => loadFileInput.click());
    loadFileInput.addEventListener('change', loadGame);

    // --- UI Language Update Function ---
    function updateLanguageUI() { /* ... no changes ... */
        const lang = translations[currentLanguage];
        document.querySelector('h1').textContent = lang.gameTitle; languageSwitchButton.textContent = (currentLanguage === 'en') ? lang.switchToFrench : lang.switchToEnglish; languageSwitchButton.title = lang.switchLanguageTooltip; colonyNameDisplay.textContent = `${lang.colonyLabel} ${colonyName}`;
        inventoryDisplay.querySelector('h2').textContent = lang.inventoryTitle; inventoryDisplay.querySelector('p:nth-of-type(1)').childNodes[0].nodeValue = `${lang.wood}: `; inventoryDisplay.querySelector('p:nth-of-type(2)').childNodes[0].nodeValue = `${lang.pebble}: `; inventoryDisplay.querySelector('p:nth-of-type(3)').childNodes[0].nodeValue = `${lang.flint}: `; inventoryDisplay.querySelector('p:nth-of-type(4)').childNodes[0].nodeValue = `${lang.wheat}: `; inventoryDisplay.querySelector('p:nth-of-type(5)').childNodes[0].nodeValue = `${lang.coal}: `; actionButton.textContent = lang.gatherButton; researchButton.textContent = lang.researchButton; buildingsButton.textContent = lang.buildingsButton; unitsButton.textContent = lang.unitsButton; logsButton.textContent = lang.logsButton; saveButton.textContent = lang.saveButton; loadButton.textContent = lang.loadButton;
        if(logsPanel) { logsPanel.querySelector('h2').textContent = lang.logsPanelTitle; logSearchInput.placeholder = lang.logSearchPlaceholder; const filterLabel = logFilterCheckbox.parentElement; if (filterLabel && filterLabel.lastChild.nodeType === Node.TEXT_NODE) { filterLabel.lastChild.nodeValue = ` ${lang.logFilterLabel}`; } else if (filterLabel) { filterLabel.appendChild(document.createTextNode(` ${lang.logFilterLabel}`)); } }
        researchPointsDisplay.parentElement.childNodes[0].nodeValue = `${lang.researchPointsLabel} `;
        if(techTree) { techTree.querySelector('h2').textContent = lang.researchPanelTitle; techTree.querySelector('h3').textContent = lang.primitiveAge; settlementResearchBtn.textContent = lang.researchSettlement; settlementResearchBtn.parentElement.querySelector('p').textContent = lang.researchSettlementDesc; agricultureResearchBtn.textContent = lang.researchAgriculture; agricultureResearchBtn.parentElement.querySelector('p').textContent = lang.researchAgricultureDesc; miningResearchBtn.textContent = lang.researchMining; miningResearchBtn.parentElement.querySelector('p').textContent = lang.researchMiningDesc; }
        if(buildingsList) buildingsList.querySelector('h2').textContent = lang.buildingsPanelTitle; if(unitsPanel) unitsPanel.querySelector('h2').textContent = lang.unitsPanelTitle;
        updateGrid(); updateUnitDisplayBar(); updateBuildingsList(); updateUnitsPanel(); updateResearchProgress(); checkResource();
        if (logsPanel.style.display === 'block') { updateLogsDisplay(); }
    }

    // --- Event Listener for Language Switch ---
    languageSwitchButton.addEventListener('click', () => { /* ... no changes ... */
        currentLanguage = (currentLanguage === 'en') ? 'fr' : 'en'; eventLogs.forEach(log => { if (log.messageKey) { let renderedMessage = translations[currentLanguage][log.messageKey] || log.messageKey; if (log.args && log.args.length > 0) { log.args.forEach((arg, index) => { const translatedArg = translations[currentLanguage][arg] || arg; renderedMessage = renderedMessage.replace(`{${index}}`, translatedArg); }); } log.rendered = renderedMessage; } }); updateLanguageUI();
    });

    // --- Game Start ---
    function startGame() { // <<< MODIFIED (call updateUnitCoordsDisplay)
        currentLanguage = 'en';
        const lang = translations[currentLanguage];
        colonyName = prompt(lang.promptColonyName, lang.defaultColonyName);
        if (!colonyName || colonyName.trim() === "") { colonyName = lang.defaultColonyName; }

        // Reset state
        nextUnitId = 0; inventory = { wood: 0, pebble: 0, flint: 0, wheat: 0, coal: 0 };
        researchPoints = 0; activeResearch = null; settlementCompleted = false; agricultureCompleted = false; miningCompleted = false;
        maxWorkers = 0; selectedBuilding = null; moveCount = 0; movesSinceLastCoal = 0; highlightEnabled = false;
        eventLogs = [{ time: getFormattedTime(), messageKey: 'logNewGame', args:[colonyName], rendered: lang.logNewGame.replace('{0}', colonyName) }];
        worldData = {}; revealedTiles = new Set();
        const startWorldX = 5; const startWorldY = 5;
        units = [{ id: `unit-${nextUnitId++}`, type: 'pawn', worldX: startWorldX, worldY: startWorldY }];
        selectedUnitId = units[0].id;
        viewOffsetX = startWorldX - VIEW_CENTER_OFFSET; viewOffsetY = startWorldY - VIEW_CENTER_OFFSET;

        // Initialize UI & World
        initializeGridDOM();
        revealArea(startWorldX, startWorldY, REVEAL_RADIUS);
        hideAllPanels();
        updateLanguageUI();
        updateInventoryDisplay(); updateResearchPointsDisplay();
        updateUnitDisplayBar();
        updateUnitCoordsDisplay(); // <<< UPDATE COORDS DISPLAY
        updateGrid();
        // checkResource(); // Called by updateGrid
        updateResearchProgress(); updateBuildingsList(); updateUnitsPanel();

        // Set initial button states
        settlementResearchBtn.disabled = false; agricultureResearchBtn.disabled = false; miningResearchBtn.disabled = true;
        researchStatusDisplay.textContent = lang.researchStatusInitial; researchStatusDisplay.style.display = 'block';

        showAlert('alertWelcome', 4000, false, [colonyName]);
    }

    // Start
    startGame();

  </script>
</body>
</html>
